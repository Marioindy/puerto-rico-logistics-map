# Convex Backend - Puerto Rico Logistics Map

This directory contains all Convex backend functions, schema, and business logic for the Puerto Rico Logistics Map application.

## Table of Contents

- [Architecture Overview](#architecture-overview)
- [Database Schema](#database-schema)
- [Functions Overview](#functions-overview)
- [Queries](#queries)
- [Mutations](#mutations)
- [Admin Mutations](#admin-mutations)
- [Development Workflow](#development-workflow)
- [Security](#security)
- [Usage Examples](#usage-examples)

---

## Architecture Overview

The Convex backend uses a **three-table hierarchy** for flexible facility data management:

```
geoLocales (locations)
  └─ facilityBoxes (UI sections)
       └─ facilityVariables (dynamic attributes)
```

This architecture allows for:
- **Flexible data structure**: Each location can have any number of UI boxes
- **Dynamic attributes**: Variables can be added without schema changes
- **Nested data**: Variables support parent-child relationships
- **Type safety**: Full TypeScript support via auto-generated types

### Key Principles

1. **Schema is source of truth**: All changes start in `schema.ts`
2. **Type generation**: TypeScript types auto-generate in `_generated/`
3. **Validation first**: All public functions validate arguments
4. **Security by default**: Admin mutations require API key authentication

---

## Database Schema

All tables automatically include:
- `_id`: Unique identifier (generated by Convex)
- `_creationTime`: Timestamp (generated by Convex)

### 1. `geoLocales` (Main Locations Table)

**Purpose**: Primary source for facility locations displayed on the map

**Fields**:
```typescript
{
  name: string;              // Facility name
  type: string;              // "warehouse" | "port" | "airport" | "facility"
  coordinates: {
    lat: number;             // Latitude
    lng: number;             // Longitude
  };
  description: string;       // Facility description
  region: string;            // "north" | "south" | "east" | "west" | "central"
  isActive: boolean;         // Whether location is active/visible
}
```

**Indexes**:
- `by_name` - Find by name
- `by_type` - Filter by type
- `by_region` - Filter by region
- `by_isActive` - Filter active/inactive

**File**: `convex/geoLocales.ts`

---

### 2. `facilityBoxes` (UI Organization Table)

**Purpose**: Groups facility information into visual boxes/sections for the FacilityInfoPanel display

**Fields**:
```typescript
{
  geoLocaleId: Id<"geoLocales">;  // Reference to parent location
  title: string;                   // Box title (e.g., "General Info")
  icon: string;                    // Icon name from lucide-react
  color: string;                   // Color theme
  sortOrder: number;               // Display order
}
```

**Valid Icons**: Info, Settings, Eye, MapPin, Database, Monitor

**Valid Colors**: blue, green, orange, purple, red, gray, cyan, indigo

**Indexes**:
- `by_geoLocaleId` - Find all boxes for a location

**File**: `convex/facilityBoxes.ts`

---

### 3. `facilityVariables` (Dynamic Metadata Table)

**Purpose**: Stores flexible, dynamic facility attributes (capacity, operating hours, dock doors, etc.)

**Fields**:
```typescript
{
  boxId: Id<"facilityBoxes">;             // Reference to parent box
  key: string;                             // Unique identifier (e.g., "capacity")
  label: string;                           // Display label (e.g., "Storage Capacity")
  type: string;                            // Variable type
  value?: string | number;                 // Actual value (optional for nested)
  sortOrder: number;                       // Display order
  parentVariableId?: Id<"facilityVariables">;  // For nested variables
  unit?: string;                           // Unit of measurement (e.g., "sqft")
  unitCategory?: string;                   // Category (distance, area, time, etc.)
}
```

**Valid Types**:
- `text` - Text value
- `email` - Email address
- `number` - Numeric value
- `coordinates` - GPS coordinates
- `nested` - Parent container (no value)

**Valid Unit Categories**: distance, area, time, capacity, volume, power, percentage

**Indexes**:
- `by_boxId` - Find all variables for a box
- `by_key` - Find variables by key

**File**: `convex/facilityVariables.ts`

---

### 4. `shipments` (Cargo Tracking Table)

**Purpose**: Track shipments between facilities with full logistics details

**Fields**:
```typescript
{
  reference: string;                      // Shipment reference number
  createdByEmail: string;                 // Creator email
  originGeoId: Id<"geoLocales">;         // Origin location
  destinationGeoId: Id<"geoLocales">;    // Destination location
  mode: string;                           // "air" | "sea" | "truck" | "multimodal"
  status: string;                         // See statuses below
  etd: number;                            // Estimated Time of Departure (timestamp)
  eta: number;                            // Estimated Time of Arrival (timestamp)
  atd?: number;                           // Actual Time of Departure (optional)
  ata?: number;                           // Actual Time of Arrival (optional)
  trackingNumber?: string;                // Tracking number
  bl?: string;                            // Bill of Lading
  awb?: string;                           // Air Waybill
  weightKg?: number;                      // Weight in kilograms
  volumeM3?: number;                      // Volume in cubic meters
  pieces?: number;                        // Number of pieces
  hazmat?: boolean;                       // Hazardous materials flag
  notes?: string;                         // Additional notes
}
```

**Valid Modes**: air, sea, truck, multimodal

**Valid Statuses**: draft, booked, in_transit, arrived, delivered, cancelled

**Indexes**:
- `by_reference` - Find by reference number
- `by_status` - Filter by status
- `by_originGeoId` - Find by origin
- `by_destinationGeoId` - Find by destination

---

## Functions Overview

### File Structure

```
convex/
├── schema.ts                    # Database schema definition (source of truth)
├── geoLocales.ts               # Locations queries + admin mutations
├── facilityBoxes.ts            # Boxes queries + admin mutations
├── facilityVariables.ts        # Variables queries + admin mutations
└── _generated/                 # Auto-generated types (do not edit)
    ├── api.d.ts
    ├── dataModel.d.ts
    └── server.d.ts
```

---

## Queries

Queries are **read-only** functions that can be subscribed to for real-time updates.

### `geoLocales.ts`

#### `list()`
List all locations with optional filters.

**Arguments**:
```typescript
{
  type?: string;           // Filter by type
  region?: string;         // Filter by region
  search?: string;         // Search in name/description
  activeOnly?: boolean;    // Default: true
}
```

**Returns**: `Array<Doc<"geoLocales">>`

**Usage**:
```typescript
const locations = useQuery(api.geoLocales.list, {
  type: "warehouse",
  region: "north"
});
```

---

#### `listWithDetails()`
List locations WITH all boxes WITH all variables (complete structure for FacilityInfoPanel).

**Arguments**: Same as `list()`

**Returns**:
```typescript
Array<{
  id: Id<"geoLocales">;
  type: 'airport' | 'port' | 'warehouse' | 'facility';
  coordinates: { lat: number; lng: number };
  data: {
    title: string;
    type: string;
    boxes: Array<{
      id: Id<"facilityBoxes">;
      title: string;
      icon: string;
      color: string;
      variables: Array<Variable & { subVariables: Variable[] }>;
    }>;
  };
}>
```

**Usage**:
```typescript
const locationsWithDetails = useQuery(api.geoLocales.listWithDetails, {
  activeOnly: true,
  search: "warehouse"
});
```

**JOIN Logic**:
1. Fetches filtered geoLocales
2. For each location → fetches facilityBoxes (sorted by sortOrder)
3. For each box → fetches facilityVariables (sorted by sortOrder)
4. Builds nested parent-child structure for variables
5. Returns complete hierarchy

---

#### `getById()`
Get a single location by ID.

**Arguments**:
```typescript
{ id: Id<"geoLocales"> }
```

**Returns**: `Doc<"geoLocales"> | null`

---

#### `getByIdWithDetails()`
Get a single location with full details (boxes and variables).

**Arguments**: Same as `getById()`

**Returns**: Same structure as `listWithDetails()` but for single location

---

### `facilityBoxes.ts`

#### `getByGeoLocaleId()`
Get all boxes for a specific location.

**Arguments**:
```typescript
{ geoLocaleId: Id<"geoLocales"> }
```

**Returns**: `Array<Doc<"facilityBoxes">>` (sorted by sortOrder)

---

#### `getById()`
Get a single box by ID.

**Arguments**:
```typescript
{ id: Id<"facilityBoxes"> }
```

**Returns**: `Doc<"facilityBoxes"> | null`

---

### `facilityVariables.ts`

#### `getByBoxId()`
Get all variables for a specific box.

**Arguments**:
```typescript
{ boxId: Id<"facilityBoxes"> }
```

**Returns**: `Array<Doc<"facilityVariables">>` (sorted by sortOrder)

---

#### `getById()`
Get a single variable by ID.

**Arguments**:
```typescript
{ id: Id<"facilityVariables"> }
```

**Returns**: `Doc<"facilityVariables"> | null`

---

#### `getByKey()`
Find variables by key across all boxes.

**Arguments**:
```typescript
{ key: string }
```

**Returns**: `Array<Doc<"facilityVariables">>`

---

## Mutations

Standard mutations are currently only available as **admin mutations** (see next section).

---

## Admin Mutations

All admin mutations require the `ADMIN_SECRET_KEY` environment variable for authentication.

### Security Model

```typescript
function validateAdminKey(adminKey: string) {
  const secretKey = process.env.ADMIN_SECRET_KEY;

  if (!secretKey) {
    throw new ConvexError("Admin functionality not configured");
  }

  if (adminKey !== secretKey) {
    throw new ConvexError("Unauthorized access");
  }
}
```

**All admin mutations**:
1. Validate API key first
2. Validate foreign key references
3. Perform data integrity checks
4. Execute cascade deletes where needed
5. Return created/updated ID

---

### `geoLocales.adminCreate()`

Create a new location.

**Arguments**:
```typescript
{
  adminKey: string;
  name: string;
  type: string;
  coordinates: { lat: number; lng: number };
  description: string;
  region: string;
  isActive: boolean;
}
```

**Returns**: `Id<"geoLocales">`

**Usage**:
```typescript
const mutation = useMutation(api.geoLocales.adminCreate);
const locationId = await mutation({
  adminKey: process.env.ADMIN_SECRET_KEY!,
  name: "New Warehouse",
  type: "warehouse",
  coordinates: { lat: 18.4, lng: -66.0 },
  description: "A new warehouse facility",
  region: "north",
  isActive: true,
});
```

---

### `geoLocales.adminUpdate()`

Update an existing location.

**Arguments**:
```typescript
{
  adminKey: string;
  id: Id<"geoLocales">;
  name?: string;
  type?: string;
  coordinates?: { lat: number; lng: number };
  description?: string;
  region?: string;
  isActive?: boolean;
}
```

**Returns**: `Id<"geoLocales">`

**Note**: All fields except `adminKey` and `id` are optional. Only provided fields will be updated.

---

### `geoLocales.adminDelete()`

Delete a location.

**Arguments**:
```typescript
{
  adminKey: string;
  id: Id<"geoLocales">;
}
```

**Returns**: `Id<"geoLocales">`

**⚠️ WARNING**: Cascade deletes all associated:
1. facilityBoxes
2. facilityVariables (for all boxes)

**Deletion Flow**:
1. Find all boxes for this location
2. For each box:
   - Find all variables
   - Delete each variable
   - Delete the box
3. Delete the location

---

### `facilityBoxes.adminCreate()`

Create a new box.

**Arguments**:
```typescript
{
  adminKey: string;
  geoLocaleId: Id<"geoLocales">;
  title: string;
  icon: string;
  color: string;
  sortOrder: number;
}
```

**Returns**: `Id<"facilityBoxes">`

**Validation**: Ensures geoLocale exists

---

### `facilityBoxes.adminUpdate()`

Update an existing box.

**Arguments**:
```typescript
{
  adminKey: string;
  id: Id<"facilityBoxes">;
  geoLocaleId?: Id<"geoLocales">;
  title?: string;
  icon?: string;
  color?: string;
  sortOrder?: number;
}
```

**Returns**: `Id<"facilityBoxes">`

**Validation**: If updating geoLocaleId, ensures new geoLocale exists

---

### `facilityBoxes.adminDelete()`

Delete a box.

**Arguments**:
```typescript
{
  adminKey: string;
  id: Id<"facilityBoxes">;
}
```

**Returns**: `Id<"facilityBoxes">`

**⚠️ WARNING**: Cascade deletes all associated facilityVariables

---

### `facilityVariables.adminCreate()`

Create a new variable.

**Arguments**:
```typescript
{
  adminKey: string;
  boxId: Id<"facilityBoxes">;
  key: string;
  label: string;
  type: string;
  value?: string | number;
  sortOrder: number;
  parentVariableId?: Id<"facilityVariables">;
  unit?: string;
  unitCategory?: string;
}
```

**Returns**: `Id<"facilityVariables">`

**Validation**:
- Box must exist
- Type must be valid (text, email, number, coordinates, nested)
- Parent variable must exist and belong to same box
- Nested variables cannot have a value

---

### `facilityVariables.adminUpdate()`

Update an existing variable.

**Arguments**:
```typescript
{
  adminKey: string;
  id: Id<"facilityVariables">;
  boxId?: Id<"facilityBoxes">;
  key?: string;
  label?: string;
  type?: string;
  value?: string | number;
  sortOrder?: number;
  parentVariableId?: Id<"facilityVariables">;
  unit?: string;
  unitCategory?: string;
}
```

**Returns**: `Id<"facilityVariables">`

**Validation**:
- If updating box, box must exist
- If updating parent, parent must exist and belong to same box
- Prevents self-referencing (variable cannot be its own parent)
- If updating type, type must be valid

---

### `facilityVariables.adminDelete()`

Delete a variable.

**Arguments**:
```typescript
{
  adminKey: string;
  id: Id<"facilityVariables">;
}
```

**Returns**: `Id<"facilityVariables">`

**⚠️ WARNING**: Cascade deletes all child variables recursively

---

## Development Workflow

### 1. Schema Changes

Edit `schema.ts`:
```typescript
// convex/schema.ts
export default defineSchema({
  geoLocales: defineTable({
    name: v.string(),
    // ... other fields
  })
    .index("by_name", ["name"])
});
```

### 2. Push to Convex

```bash
# Development (watches for changes)
npx convex dev

# One-time push
npx convex dev --once

# Deploy to production
npx convex deploy
```

### 3. Type Generation

Types auto-generate in `_generated/`:
- `api.d.ts` - Function signatures
- `dataModel.d.ts` - Database types
- `server.d.ts` - Server context types

### 4. Import in Code

```typescript
import { api } from "@/convex/_generated/api";
import type { Doc, Id } from "@/convex/_generated/dataModel";

// Use in React components
const data = useQuery(api.geoLocales.list);
const mutate = useMutation(api.geoLocales.adminCreate);
```

---

## Security

### Environment Variables

Set `ADMIN_SECRET_KEY` in:

**Local Development** (`.env.local`):
```bash
ADMIN_SECRET_KEY=your-secret-key-here
```

**Production** (Convex Dashboard):
1. Go to Settings → Environment Variables
2. Add `ADMIN_SECRET_KEY` with your secret value

### Security Rules

1. **Never expose `ADMIN_SECRET_KEY` in client-side code**
2. **All admin mutations validate the key before executing**
3. **Failed authentication throws clear errors**:
   - `ConvexError("Unauthorized access")` - Wrong key
   - `ConvexError("Admin functionality not configured")` - Missing key
4. **All mutations include data validation**:
   - Foreign key checks (parent records must exist)
   - Type validation
   - Self-referencing prevention
   - Cascade delete warnings

### Best Practices

❌ **Don't do this** (exposes key to client):
```typescript
// In a React component
const mutation = useMutation(api.geoLocales.adminCreate);
mutation({
  adminKey: "my-secret-key", // NEVER HARDCODE
  // ...
});
```

✅ **Do this instead** (server-side only):
```typescript
// In a Convex action or server-side script
import { api } from "../convex/_generated/api";

export const createLocation = action({
  handler: async (ctx, args) => {
    return await ctx.runMutation(api.geoLocales.adminCreate, {
      adminKey: process.env.ADMIN_SECRET_KEY!,
      ...args,
    });
  },
});
```

---

## Usage Examples

### Example 1: Display Locations on Map

```typescript
// app/rfimap/rfimap.tsx
import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";

export default function RfiMapPage() {
  const locations = useQuery(api.geoLocales.listWithDetails, {
    type: "warehouse",
    region: "north",
    activeOnly: true,
  });

  return (
    <InteractiveMap
      markers={locations ?? []}
      onMarkerClick={(marker) => {
        console.log("Clicked:", marker.data.title);
        console.log("Boxes:", marker.data.boxes);
      }}
    />
  );
}
```

### Example 2: Create a Complete Location (Server-Side)

```typescript
// convex/actions/setupLocation.ts
import { action } from "./_generated/server";
import { api } from "./_generated/api";

export const setupCompleteLocation = action({
  handler: async (ctx) => {
    const adminKey = process.env.ADMIN_SECRET_KEY!;

    // 1. Create location
    const locationId = await ctx.runMutation(api.geoLocales.adminCreate, {
      adminKey,
      name: "San Juan Warehouse",
      type: "warehouse",
      coordinates: { lat: 18.4655, lng: -66.1057 },
      description: "Main distribution center",
      region: "north",
      isActive: true,
    });

    // 2. Create boxes
    const infoBoxId = await ctx.runMutation(api.facilityBoxes.adminCreate, {
      adminKey,
      geoLocaleId: locationId,
      title: "General Information",
      icon: "Info",
      color: "blue",
      sortOrder: 1,
    });

    const capacityBoxId = await ctx.runMutation(api.facilityBoxes.adminCreate, {
      adminKey,
      geoLocaleId: locationId,
      title: "Capacity",
      icon: "Database",
      color: "green",
      sortOrder: 2,
    });

    // 3. Create variables
    await ctx.runMutation(api.facilityVariables.adminCreate, {
      adminKey,
      boxId: infoBoxId,
      key: "address",
      label: "Address",
      type: "text",
      value: "123 Main St, San Juan, PR",
      sortOrder: 1,
    });

    await ctx.runMutation(api.facilityVariables.adminCreate, {
      adminKey,
      boxId: capacityBoxId,
      key: "total_area",
      label: "Total Area",
      type: "number",
      value: 50000,
      unit: "sqft",
      unitCategory: "area",
      sortOrder: 1,
    });

    return locationId;
  },
});
```

### Example 3: Nested Variables

```typescript
// Create parent variable
const shippingId = await ctx.runMutation(api.facilityVariables.adminCreate, {
  adminKey,
  boxId: boxId,
  key: "shipping",
  label: "Shipping Information",
  type: "nested",  // No value
  sortOrder: 1,
});

// Create child variables
await ctx.runMutation(api.facilityVariables.adminCreate, {
  adminKey,
  boxId: boxId,
  key: "shipping_dock_doors",
  label: "Dock Doors",
  type: "number",
  value: 12,
  parentVariableId: shippingId,  // Links to parent
  sortOrder: 1,
});

await ctx.runMutation(api.facilityVariables.adminCreate, {
  adminKey,
  boxId: boxId,
  key: "shipping_operating_hours",
  label: "Operating Hours",
  type: "text",
  value: "Mon-Fri 8AM-6PM",
  parentVariableId: shippingId,
  sortOrder: 2,
});
```

### Example 4: Query and Display Box Data

```typescript
// Get all boxes for a location
const boxes = useQuery(api.facilityBoxes.getByGeoLocaleId, {
  geoLocaleId: locationId,
});

// For each box, get variables
{boxes?.map((box) => {
  const variables = useQuery(api.facilityVariables.getByBoxId, {
    boxId: box._id,
  });

  return (
    <div key={box._id} style={{ borderColor: box.color }}>
      <Icon name={box.icon} />
      <h3>{box.title}</h3>
      {variables?.map((v) => (
        <div key={v._id}>
          <label>{v.label}:</label>
          <span>{v.value} {v.unit}</span>
        </div>
      ))}
    </div>
  );
})}
```

---

## Common Patterns

### Pattern 1: Filtering Locations

```typescript
// By type
const warehouses = useQuery(api.geoLocales.list, { type: "warehouse" });

// By region
const northLocations = useQuery(api.geoLocales.list, { region: "north" });

// By search term
const searchResults = useQuery(api.geoLocales.list, {
  search: "distribution"
});

// Multiple filters
const filtered = useQuery(api.geoLocales.list, {
  type: "warehouse",
  region: "north",
  search: "san juan",
  activeOnly: true,
});
```

### Pattern 2: Update Partial Fields

```typescript
// Only update what you need
await mutation(api.geoLocales.adminUpdate, {
  adminKey: process.env.ADMIN_SECRET_KEY!,
  id: locationId,
  isActive: false,  // Only deactivate, keep everything else
});
```

### Pattern 3: Safe Cascade Deletes

```typescript
// Get confirmation before deleting
const confirmDelete = window.confirm(
  "This will delete the location and ALL associated boxes and variables. Continue?"
);

if (confirmDelete) {
  await mutation(api.geoLocales.adminDelete, {
    adminKey: process.env.ADMIN_SECRET_KEY!,
    id: locationId,
  });
}
```

---

## Troubleshooting

### Issue: "Admin functionality not configured"

**Cause**: `ADMIN_SECRET_KEY` not set in environment

**Solution**:
```bash
# Local
npx convex env set ADMIN_SECRET_KEY "your-key-here"

# Or add to .env.local
echo 'ADMIN_SECRET_KEY=your-key-here' >> .env.local
```

### Issue: "Unauthorized access"

**Cause**: Wrong API key provided

**Solution**: Verify you're using the correct key from environment variables

### Issue: Types out of sync

**Cause**: Schema changed but types not regenerated

**Solution**:
```bash
npx convex dev --once
```

### Issue: "GeoLocale not found" when creating box

**Cause**: Referenced geoLocale doesn't exist

**Solution**: Ensure the location exists before creating boxes

---

## Resources

- [Convex Documentation](https://docs.convex.dev/)
- [Convex Functions](https://docs.convex.dev/functions)
- [Convex Database](https://docs.convex.dev/database)
- [Convex Auth](https://docs.convex.dev/auth)
- [Project README](../README.md)
- [Claude Guide](../CLAUDE.md)
- [Agents Guide](../agents.md)

---

## Quick Reference

### Commands

```bash
# Development
npx convex dev              # Watch mode
npx convex dev --once       # One-time push
npx convex deploy           # Deploy to production

# Environment
npx convex env set KEY value    # Set env var
npx convex env get KEY          # Get env var
npx convex env list             # List all vars

# Help
npx convex -h               # CLI help
npx convex docs             # Open docs
```

### Import Patterns

```typescript
// API (for client)
import { api } from "@/convex/_generated/api";

// Types
import type { Doc, Id } from "@/convex/_generated/dataModel";

// Server (for Convex functions)
import { query, mutation, action } from "./_generated/server";
import { v } from "convex/values";
import { ConvexError } from "convex/values";
```

### Hook Patterns

```typescript
// Query (read, real-time)
const data = useQuery(api.module.functionName, args);

// Mutation (write)
const mutate = useMutation(api.module.functionName);
await mutate(args);

// Action (external calls)
const act = useAction(api.module.functionName);
await act(args);
```

---

**Last Updated**: 2025-10-02
**Convex Version**: Latest
**Project**: Puerto Rico Logistics Map
